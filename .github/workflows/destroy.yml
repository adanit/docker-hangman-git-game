# ğŸ—‘ï¸ PIPELINE DE LIMPEZA - Terraform Destroy
# Este arquivo remove todos os recursos usando Terraform

name: ğŸ—‘ï¸ Destroy Git Game Infrastructure

# ğŸ¯ QUANDO EXECUTAR
on:
  workflow_dispatch:     # SÃ³ executa manualmente (seguranÃ§a)
    inputs:
      confirm:
        description: 'Digite "DESTROY" para confirmar'
        required: true
        default: ''

# ğŸ’¼ JOBS (Trabalhos que serÃ£o executados)
jobs:
  destroy:
    runs-on: ubuntu-latest
    
    # âš ï¸ VALIDAÃ‡ÃƒO DE SEGURANÃ‡A
    if: github.event.inputs.confirm == 'DESTROY'
    
    steps:
    # ğŸ PASSO 1: Baixar cÃ³digo do repositÃ³rio
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # ğŸ PASSO 2: Autenticar no Azure
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    # ğŸ PASSO 3: Instalar Terraform
    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        
    # ğŸ PASSO 4: Inicializar Terraform com backend
    - name: ğŸ”§ Terraform Init
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        terraform init
        
    # ğŸ PASSO 5: Planejar destruiÃ§Ã£o
    - name: ğŸ“‹ Terraform Plan Destroy
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        terraform plan -destroy
        
    # ğŸ PASSO 6: Executar destruiÃ§Ã£o
    - name: ğŸ—‘ï¸ Terraform Destroy
      run: |
        cd terraform
        export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
        export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
        export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
        export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"
        
        terraform destroy -auto-approve
        
    # ğŸ PASSO 7: ConfirmaÃ§Ã£o
    - name: âœ… Destroy Complete
      run: |
        echo "ğŸ‰ DESTRUIÃ‡ÃƒO COMPLETA!"
        echo ""
        echo "ğŸ“‹ Recursos removidos:"
        echo "  â€¢ Resource Group: rg-git-game"
        echo "  â€¢ Container Registry"
        echo "  â€¢ Container Instances"
        echo "  â€¢ Todas as imagens Docker"
        echo ""
        echo "ğŸ’° Custo: R$ 0,00 a partir de agora!"