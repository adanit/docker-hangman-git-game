name: Deploy Git Game no Azure

# Quando Executar o Workflow
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite executar a pipeline manualmente

# Vari√°veis Globais
env:
  REGISTRY_NAME: gitgame

# Jobs do Workflow
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Passo 1: Fazer o checkout do c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4

      # Passo 2: Login no Azure
      - name: Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Passo 3: Instalar o Terraform
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      # Passo 4: Executar o Terraform
      - name: Terraform Init
        run: |
          cd terraform
          export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
          export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
          export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
          export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"

          terraform init

      # Passo 5: Planejar a Infraestrutura
      - name: Terraform Plan
        run: |
          cd terraform
          export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
          export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
          export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
          export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"

          terraform plan -target=azurerm_resource_group.gitgame -target=azurerm_container_registry.gitgame -target=random_string.suffix

      # Passo 6: Aplicar a Infraestrutura B√°sica
      - name: Terraform Apply
        run: |
          cd terraform
          export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
          export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
          export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
          export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"

          terraform apply -auto-approve -target=azurerm_resource_group.gitgame -target=azurerm_container_registry.gitgame -target=random_string.suffix

      # Passo 7: Build das Imagens e Push para o ACR
      - name: Build and Push Images
        run: |
          # Configurar Terraform
          export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
          export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
          export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
          export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"

          ACR_SERVER=$(cd terraform && terraform output -raw acr_login_server)
          ACR_USERNAME=$(cd terraform && terraform output -raw acr_admin_username)
          ACR_PASSWORD=$(cd terraform && terraform output -raw acr_admin_password)
          RANDOM_SUFFIX=$(cd terraform && terraform output -raw random_suffix)

          echo $ACR_PASSWORD | docker login $ACR_SERVER -u $ACR_USERNAME --password-stdin

          docker build -t $ACR_SERVER/gitgame-db:latest ./db
          docker push $ACR_SERVER/gitgame-db:latest

          docker build -t $ACR_SERVER/gitgame-backend:latest ./backend
          docker push $ACR_SERVER/gitgame-backend:latest

          docker build \
            --build-arg VITE_API_URL="http://gitgame-${RANDOM_SUFFIX}.eastus.azurecontainer.io:8000" \
            -t $ACR_SERVER/gitgame-frontend:latest ./frontend
          docker push $ACR_SERVER/gitgame-frontend:latest

      # Passo 8: Deploy dos Containers
      - name: Deploy dos Containers
        run: |
          cd terraform
          export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
          export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
          export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
          export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"

          if terraform state show azurerm_container_group.gitgame >/dev/null 2>&1; then
            terraform taint azurerm_container_group.gitgame
          fi

          terraform apply -auto-approve

      # Passo 9: URLs da Aplica√ß√£o
      - name: Exibir URLs da Aplica√ß√£o
        run: |
          cd terraform
          export ARM_CLIENT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}"
          export ARM_CLIENT_SECRET="${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}"
          export ARM_TENANT_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}"
          export ARM_SUBSCRIPTION_ID="${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}"

          echo "üéÆ Git Game URLs:"
          echo "üåê Frontend: $(terraform output -raw application_url)"
          echo "üîó API: $(terraform output -raw api_url)"
          echo ""
          echo "üéâ Deploy conclu√≠do! Aguarde 2-3 minutos para ficar dispon√≠vel."
      
      # Passo 10: Exibir Mensagem de Sucesso